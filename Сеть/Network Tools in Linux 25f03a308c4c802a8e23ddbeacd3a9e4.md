# Network Tools in Linux

---

**Слайд 1 — Цель урока**

**Основная цель:**

Приобрести практические навыки диагностики сетевых проблем в Linux, чтобы в реальных условиях мы могли быстро и эффективно находить причину неисправности.

**Подцели:**

1. **Скорость диагностики**
    - Уметь использовать минимальный набор команд для первичной проверки.
    - Сократить время поиска причины инцидента.
2. **Освоение инструментов**
    - Изучить базовые утилиты (`ping`, `ip`, `ss`, `dig`, `traceroute`).
    - Познакомиться с продвинутыми инструментами (`mtr`, `tcpdump`, `iftop`).
3. **Определение источника проблемы**
    - Отличать сбой в приложении от сетевой проблемы.
    - Уметь локализовать неисправность: клиент, сервер, маршрутизатор, провайдер.

**Практическая ценность:**

- Навык применять команды и интерпретировать их вывод.
- Подготовка к работе с инцидентами в продакшене.
- Повышение качества взаимодействия с командой разработки и сетевыми инженерами.

---

---

## **Слайд 2 — Этапы диагностики**

**Цель слайда:**

Понять логическую последовательность проверки сети, чтобы не тратить время на хаотичные попытки.

---

**1. Проверка сетевого интерфейса**

- Убедиться, что интерфейс включён (UP) и есть линк.
- Инструменты:
    - `ip link` — состояние интерфейсов.
    - `ethtool` — физическое соединение и скорость.

**2. Проверка IP-адреса и маршрутов**

- Есть ли у хоста корректный IP-адрес?
- Есть ли маршрут по умолчанию и до нужного хоста?
- Инструменты:
    - `ip a` — адреса на интерфейсах.
    - `ip r` — таблица маршрутизации.

**3. Тест доступности хоста**

- Проверить, отвечает ли удалённый IP.
- Инструменты:
    - `ping` — ICMP-доступность.
    - `fping` — массовая проверка сети.

**4. Проверка DNS**

- Работает ли разрешение доменных имён?
- Инструменты:
    - `dig`, `nslookup` — проверка ответов DNS-сервера.

**5. Трассировка маршрута**

- Определить, на каком участке теряются пакеты или растёт задержка.
- Инструменты:
    - `traceroute` — стандартная трассировка.
    - `mtr` — трассировка + статистика потерь.

**6. Диагностика портов и сервисов**

- Проверить, доступен ли нужный порт на удалённом хосте.
- Инструменты:
    - `nc`, `telnet` — тест подключения.
    - `ss`, `netstat` — список активных соединений.

**7. Анализ трафика**

- Если проблема не очевидна, анализировать пакеты и нагрузку.
- Инструменты:
    - `tcpdump` — захват трафика.
    - `iftop`, `nload` — мониторинг объёма трафика в реальном времени.

---

---

## **Слайд 3 — Проверка интерфейсов**

**Задача:**

Убедиться, что сетевой адаптер активен, корректно работает физический линк и система его видит.

---

### **1. Просмотр интерфейсов**

```bash
ip a

```

- Показывает список всех интерфейсов, их состояния (UP/DOWN), MAC-адреса и IP.
- Важно: наличие `state UP` не гарантирует наличие линка, только что интерфейс включён в ОС.

---

### **2. Проверка состояния линка**

```bash
ip link

```

- Показывает состояние каждого интерфейса без привязки к IP.
- `state DOWN` → интерфейс выключен.
- `state UNKNOWN` → обычно для виртуальных интерфейсов.

---

### **3. Проверка физического соединения**

```bash
ethtool eth0

```

Ключевые параметры:

- `Link detected: yes/no` — есть ли физическое соединение.
- `Speed: 1000Mb/s` — скорость соединения.
- `Duplex: Full/Half` — режим дуплекса.

---

### **4. Пример проблемы**

- Симптом: нет доступа в сеть.
- Диагностика:
    
    ```bash
    ip link show eth0
    
    ```
    
    Результат:
    
    ```
    2: eth0: <BROADCAST,MULTICAST> mtu 1500 qdisc noop state DOWN
    
    ```
    
- Решение:
    
    ```bash
    ip link set eth0 up
    
    ```
    

---

### **5. Возможные причины DOWN**

- Кабель не подключен.
- Порт на коммутаторе выключен или заблокирован.
- Ошибки в конфигурации (netplan, NetworkManager, systemd-networkd).
- Виртуальный интерфейс не поднят в гипервизоре.

---

---

## **Слайд 4 — Проверка IP и маршрутов**

**Задача:**

Убедиться, что хост имеет корректный IP-адрес и таблицу маршрутизации, чтобы пакеты доходили до нужных узлов.

---

### **1. Проверка IP-адреса интерфейса**

```bash
ip addr show eth0

```

- Показывает:
    - IP-адрес (`inet 192.168.0.10/24`)
    - Маску подсети (`/24`)
    - MAC-адрес (`link/ether`)
    - Состояние интерфейса (`state UP/DOWN`)
- **Ошибка:** если нет `inet`, IP-адрес не назначен.

---

### **2. Просмотр таблицы маршрутов**

```bash
ip route show

```

- **default via 192.168.0.1** — шлюз по умолчанию.
- **192.168.0.0/24 dev eth0** — маршрут для локальной сети.
- Используется для понимания, куда пойдут пакеты без явного маршрута.

---

### **3. Проверка маршрута до конкретного адреса**

```bash
ip route get 8.8.8.8

```

Пример вывода:

```
8.8.8.8 via 192.168.0.1 dev eth0 src 192.168.0.10

```

- `via` — через какой шлюз пойдёт трафик.
- `dev` — интерфейс, через который он выйдет.
- `src` — с каким исходящим IP он будет отправлен.

---

### **4. Типичная ошибка**

**Симптом:**

- Пинг внутри локальной сети работает, а до внешних адресов нет.

**Диагностика:**

```bash
ip route show

```

Результат:

```
192.168.0.0/24 dev eth0 proto kernel scope link src 192.168.0.10

```

— нет строки `default via ...`.

---

### **5. Исправление**

```bash
ip route add default via 192.168.0.1

```

- Добавляет шлюз по умолчанию.
- После перезагрузки может исчезнуть — для постоянного сохранения нужно добавить в `/etc/netplan/*.yaml` или конфиг NetworkManager.

---

### **6. Возможные причины проблем с маршрутами**

- DHCP-сервер не выдал шлюз.
- Ручная настройка IP без указания маршрута.
- Конфликты при нескольких активных интерфейсах.
- Ошибки в VPN-конфигурации (перезаписывает маршрут по умолчанию).

---

---

## **Слайд 5 — Проверка доступности**

**Задача:**

Проверить, можно ли достучаться до узла по сети, и выявить, на каком этапе пропадает связь.

---

### **1. Проверка с помощью `ping`**

```bash
ping -c 4 8.8.8.8

```

- **`c 4`** — отправить 4 пакета и завершить.
- ICMP-запросы помогают проверить:
    - есть ли соединение до узла;
    - какая средняя задержка (`avg`);
    - есть ли потеря пакетов (`packet loss`).
- Пример вывода:

```
64 bytes from 8.8.8.8: icmp_seq=1 ttl=118 time=23.4 ms
--- 8.8.8.8 ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3005ms
rtt min/avg/max/mdev = 22.1/23.0/23.8/0.3 ms

```

---

### **2. Проверка с помощью `fping` (массовый пинг)**

```bash
fping -a -g 192.168.0.0/24

```

- **`a`** — показывать только доступные хосты.
- **`g`** — сгенерировать диапазон адресов.
- Используется для сканирования сети, например, чтобы найти все активные устройства.
- Пример вывода:

```
192.168.0.1 is alive
192.168.0.10 is alive
192.168.0.15 is alive

```

---

### **3. Типичные ситуации**

- **Пинг до IP проходит, но до домена нет** — проблема с DNS.
- **Пинг до локального узла есть, до внешнего нет** — проблема с маршрутом или провайдером.
- **Потери пакетов** — возможны перегрузка канала, плохой кабель, проблемы у провайдера.

---

### **4. Замечания по использованию**

- Некоторые серверы могут блокировать ICMP — отсутствие ответа не всегда значит недоступность сервиса.
- Для проверки именно TCP/UDP портов лучше использовать `nc` или `telnet`.

---

---

## **Слайд 6 — Проверка DNS**

**Задача:**

Проверить, корректно ли работает система разрешения доменных имён.

---

### **1. Проверка через `dig`**

```bash
dig ya.ru

```

- Показывает:
    - Адрес запрашиваемого DNS-сервера (`SERVER`).
    - Разрешённый IP (`ANSWER SECTION`).
    - Время ответа (`Query time`).
- Пример:

```
;; ANSWER SECTION:
ya.ru.        300 IN A 87.250.250.242

```

---

### **2. Проверка через другой DNS-сервер**

```bash
dig ya.ru @8.8.8.8

```

- Принудительно использует указанный DNS (в данном случае Google DNS).
- Полезно, чтобы исключить проблему локального DNS-сервера.

---

### **3. Проверка через `nslookup`**

```bash
nslookup ya.ru

```

- Более простой инструмент.
- Пример:

```
Server:   192.168.0.1
Address:  192.168.0.1#53

Non-authoritative answer:
Name: ya.ru
Address: 87.250.250.242

```

---

### **4. Типичные проблемы**

- **Пинг по IP есть, по домену нет** → DNS не работает.
- **Ответ от DNS долго приходит** → перегрузка или проблемы маршрута.
- **Нет ответа вообще** → сервер не доступен или порт 53 заблокирован.

---

### **5. Временное решение**

```bash
echo "nameserver 8.8.8.8" > /etc/resolv.conf

```

- Задаёт Google DNS напрямую.
- **Важно:** при перезапуске сетевых сервисов файл может перезаписываться.
- Для постоянного изменения — править настройки в:
    - `/etc/netplan/*.yaml` (Ubuntu, Netplan)
    - `/etc/network/interfaces` (Debian)
    - NetworkManager (`nmcli con mod ...`)

---

### **6. Примечания**

- Для проверки UDP-порта 53 можно использовать:

```bash
nc -vu 8.8.8.8 53

```

- Иногда проблемы бывают не в DNS, а в межсетевых фильтрах, которые блокируют порт 53.

---

---

## **Слайд 7 — Трассировка маршрута**

**Задача:** определить путь, по которому пакеты идут от вашего хоста до целевого сервера, и выявить, на каком участке возникают проблемы (задержки, потери).

---

### **1. traceroute — классическая трассировка**

- **Что делает:** отправляет пакеты с увеличивающимся значением TTL (Time To Live) и фиксирует IP-адрес каждого узла (роутера) на пути.
- **Пример запуска:**

```bash
traceroute ya.ru

```

- **Вывод показывает:**
    - Список всех промежуточных маршрутизаторов.
    - Задержку (RTT) до каждого узла.
- **Когда полезно:** быстро понять, на каком этапе маршрут "рвётся" или появляется задержка.

---

### **2. mtr — трассировка + статистика**

- **Что делает:** совмещает `traceroute` и `ping` в одном инструменте. В реальном времени собирает статистику по задержкам и потерям пакетов на каждом узле.
- **Пример запуска:**

```bash
mtr -rw ya.ru

```

- `r` — вывести итоговый отчёт и завершить (report mode).
- `w` — вывод в удобном виде (wide report).
- **Вывод показывает:**
    - Процент потерь пакетов на каждом участке.
    - Среднюю, минимальную и максимальную задержку.
- **Когда полезно:** диагностировать нестабильность канала или периодические потери.

---

💡 **Рекомендация:**

Сначала использовать `mtr` для быстрой диагностики, так как он даёт больше статистики, чем обычный `traceroute`. Если `mtr` недоступен, можно установить пакет `mtr` (в Linux) или `winmtr` (в Windows).

---

---

## **Слайд 8 — Диагностика портов**

### **1. `nc` (netcat)**

- Используется для проверки доступности TCP/UDP-портов.
- Ключи:
    - `z` — режим сканирования (не отправляет данные).
    - `v` — подробный вывод (verbose).
- Пример:
    
    ```bash
    nc -zv ya.ru 443
    
    ```
    
    Что произойдёт:
    
    - Пытается подключиться к `ya.ru` на порт `443` (HTTPS).
    - Вернёт *succeeded* или *failed*.

---

### **2. `telnet`**

- Устаревший инструмент, но иногда полезен, если `nc` отсутствует.
- Работает только с TCP.
- Пример:
    
    ```bash
    telnet ya.ru 80
    
    ```
    
    Что произойдёт:
    
    - Пытается открыть TCP-сессию с портом `80` (HTTP).
    - Если соединение установлено — порт открыт, можно вручную ввести HTTP-запрос.

---

### **3. `ss` (замена `netstat`)**

- Предназначен для отображения открытых портов и сетевых подключений.
- Основные команды:
    
    ```bash
    ss -tuln   # Показать все слушающие порты (TCP/UDP)
    ss -tan    # Показать все активные TCP-подключения
    
    ```
    
    Ключи:
    
    - `t` — TCP.
    - `u` — UDP.
    - `l` — только слушающие порты.
    - `n` — не резолвить имена (показывать IP и порты в числовом виде).
    - `a` — все подключения (в т.ч. установленные).

---

---

## **Слайд 9 — Анализ трафика**

### **1. tcpdump** — просмотр сетевых пакетов

- Используется для анализа пакетов "на лету".
- Можно фильтровать по протоколу, порту, IP-адресу.
- Полезно для диагностики сетевых проблем (падение соединений, медленный ответ, неожиданный трафик).

**Пример:**

```bash
tcpdump -i eth0 port 80

```

- `i eth0` — интерфейс для прослушивания (например, eth0, ens33, wlan0).
- `port 80` — фильтр по порту (HTTP).
- Можно дополнять: `host 192.168.1.10`, `tcp`, `udp`.

**Полезные ключи:**

```bash
tcpdump -i eth0 -n -nn -v

```

- `n` — не преобразовывать IP в DNS-имена (ускоряет вывод).
- `nn` — также не преобразовывать номера портов в сервисы.
- `v`, `vv` — подробный вывод.

---

### **2. iftop** — топ по трафику в реальном времени

- Показывает, кто и сколько трафика генерирует.
- Сортирует по нагрузке (аналог `top` для процессов).
- Удобно для выявления "пожирателей" канала.

**Пример:**

```bash
iftop -i eth0

```

- `i eth0` — интерфейс.
- Клавиши в интерфейсе:
    - `t` — переключение отображения входящего/исходящего трафика.
    - `p` — пауза.
    - `q` — выход.

---

### **3. nload** — графический мониторинг трафика

- Отображает входящий и исходящий трафик в виде графика.
- Удобно для оценки общей нагрузки в моменте.

**Пример:**

```bash
nload eth0

```

- `eth0` — интерфейс для мониторинга.
- Можно переключаться между интерфейсами стрелками.

---

---

## **Слайд 10 — Частые проблемы и решения**

| **Проблема** | **Возможная причина** | **Проверка** | **Решение** |
| --- | --- | --- | --- |
| **Нет IP** | DHCP-сервер не выдал адрес, интерфейс выключен | `ip a` — нет IP в нужной подсети | Включить интерфейс: `ip link set eth0 up`; запросить IP: `dhclient eth0` |
| **Пинг по IP есть, по домену нет** | DNS не отвечает или неправильно настроен | `dig ya.ru` / `nslookup ya.ru` | Указать другой DNS-сервер: `echo "nameserver 8.8.8.8" > /etc/resolv.conf` |
| **Пакеты теряются на 1–2 хопе** | Проблема в локальной сети (кабель, порт коммутатора, Wi-Fi) | `mtr -rw 8.8.8.8` — потери на первых узлах | Проверить кабель, порт, сменить Wi-Fi-точку, перезапустить сетевое оборудование |
| **Порт закрыт** | Блокировка на firewall (локально или у провайдера) | `nc -zv host 80` / `ss -tuln` | Разрешить порт: `iptables -A INPUT -p tcp --dport 80 -j ACCEPT` или `firewall-cmd --add-port=80/tcp --permanent` |
| **Сеть есть, но медленно** | Перегрузка канала, потери пакетов, ошибки на интерфейсе | `iftop -i eth0`, `ethtool eth0` | Ограничить фоновые загрузки, устранить аппаратные ошибки, сменить кабель |

---

💡 **Совет для реальной диагностики:**

1. Всегда проверяй **физический уровень** (линк, кабель, Wi-Fi) перед сложными тестами.
2. Сохраняй вывод команд (`ip a`, `mtr`, `ss`) — пригодится для передачи в поддержку.
3. Делай проверку от клиента к серверу и в обратную сторону — иногда проблема несимметричная.

---

---

## **Слайд 11 — Мини-чеклист диагностики (расширенная версия)**

### 1. **`ip a` — интерфейсы**

- **Что показывает:** список сетевых интерфейсов, их состояния (UP/DOWN), IP-адреса (IPv4 и IPv6), MAC-адреса.
- **Что проверять:**
    - Есть ли нужный IP на интерфейсе.
    - Не находится ли интерфейс в состоянии `DOWN`.
- **Пример:**
    
    ```bash
    ip a | grep inet
    
    ```
    

---

### 2. **`ip r` — маршруты**

- **Что показывает:** таблицу маршрутизации — куда и через какой шлюз идут пакеты.
- **Что проверять:**
    - Есть ли маршрут по умолчанию (`default via ...`).
    - Присутствует ли маршрут до нужной сети.
- **Пример:**
    
    ```bash
    ip r
    
    ```
    

---

### 3. **`ping` — доступность IP**

- **Что проверяет:** базовую сетевую связность до IP.
- **Что важно:**
    - Начинать с пинга ближайшего шлюза, потом целевого хоста.
    - Высокий `time` → возможные проблемы с сетью.
- **Пример:**
    
    ```bash
    ping -c 4 8.8.8.8
    
    ```
    

---

### 4. **`dig` — проверка DNS**

- **Что проверяет:** разрешение доменных имён в IP-адреса.
- **Что важно:**
    - Сравнить результат с ожиданиями.
    - Проверить конкретный DNS-сервер, если есть подозрения.
- **Пример:**
    
    ```bash
    dig example.com @8.8.8.8
    
    ```
    

---

### 5. **`mtr` — трассировка**

- **Что проверяет:** маршрут пакета и задержки на каждом узле.
- **Что важно:**
    - Потери на определённом хопе → возможная проблема на этом участке.
    - Использовать `T` для TCP или `u` для UDP, если ICMP заблокирован.
- **Пример:**
    
    ```bash
    mtr -T example.com
    
    ```
    

---

### 6. **`nc` / `ss` — проверка портов**

- **`nc` (netcat):**
    - Проверяет доступность TCP/UDP порта.
    - Пример:
        
        ```bash
        nc -vz example.com 443
        
        ```
        
- **`ss`:**
    - Показывает открытые сокеты и подключения.
    - Пример:
        
        ```bash
        ss -tulnp
        
        ```
        

---

### 7. **`tcpdump` — захват пакетов**

- **Что делает:** показывает сетевой трафик в реальном времени.
- **Что важно:**
    - Можно фильтровать по IP, порту, протоколу.
    - Использовать для поиска неожиданных пакетов или подтверждения обмена.
- **Примеры:**
    
    ```bash
    tcpdump -i eth0 port 443
    tcpdump -i eth0 host 192.168.0.10
    
    ```
    

---