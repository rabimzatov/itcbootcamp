# Firewall

---

## **Слайд 1 — Что такое файрвол (подробно)**

### 1. Определение

- **Файрвол** (firewall) — программный или аппаратный механизм, который контролирует прохождение сетевых пакетов через сервер или компьютер.
- Основная цель: **разрешить или запретить** определённые соединения на основе правил.

---

### 2. Как он работает

- На сервер поступает сетевой пакет (например, запрос по HTTP).
- Пакет проходит через систему фильтрации (**Netfilter** в Linux).
- Файрвол сравнивает пакет с набором правил:
    - Если пакет соответствует правилу «разрешить» — он пропускается.
    - Если соответствует правилу «запретить» — отбрасывается.
- Решения принимаются **автоматически**, без участия пользователя.

---

### 3. Применение

- **Защита серверов**
    
    Пример: разрешить вход только на порт 22 (SSH), запретить всё остальное.
    
- **Ограничение входящего трафика**
    
    Пример: блокировать входящие соединения с IP-адресов из «чёрного списка».
    
- **Ограничение исходящего трафика**
    
    Пример: запретить серверу отправлять данные на внешние SMTP-серверы.
    
- **Реализация политики безопасности**
    
    Пример: разрешить доступ к внутреннему API только с IP корпоративной сети.
    

---

### 4. Ключевые особенности

- Работает на **сетевом уровне** (уровни 3–4 модели OSI).
- Не занимается шифрованием, аутентификацией или анализом содержимого пакета (это делают IDS/IPS).
- Может быть:
    - **Программный** (iptables, firewalld, nftables).
    - **Аппаратный** (Cisco ASA, Fortinet, Mikrotik).

---

---

## **Слайд 2 — Уровень работы**

### 1. Где работает файрвол в Linux

- Фильтрация сетевого трафика происходит **внутри ядра Linux**, до того как пакет попадёт в пользовательские приложения.
- Это значит, что файрвол может заблокировать соединение **ещё до** того, как программа узнает о попытке подключения.

---

### 2. Netfilter

- **Netfilter** — встроенная подсистема ядра Linux для работы с сетевыми пакетами.
- Задачи Netfilter:
    1. Перехват пакетов, проходящих через сетевой стек.
    2. Передача их в обработчики (цепочки правил).
    3. Принятие решения: пропустить, изменить или отбросить пакет.
- Место работы в сетевом стеке: **уровни 3–4 модели OSI** (IP и TCP/UDP).

---

### 3. Поток пакетов в Linux (упрощённо)

1. **Входящий пакет** → Netfilter проверяет входящие цепочки (**INPUT**).
2. **Исходящий пакет** → Netfilter проверяет исходящие цепочки (**OUTPUT**).
3. **Транзитный пакет** (если сервер — маршрутизатор) → проверка цепочки (**FORWARD**).

---

### 4. Инструменты для управления Netfilter

- **iptables**
    - Классический инструмент для настройки Netfilter.
    - Работает с таблицами (filter, nat, mangle) и цепочками правил.
    - Устаревает, но широко используется.
- **nftables**
    - Новый стандарт (ядро Linux ≥ 3.13).
    - Объединяет функционал iptables, ip6tables, arptables, ebtables.
    - Более простой синтаксис и выше производительность.
- **firewalld**
    - Упрощённый интерфейс к iptables/nftables.
    - Поддерживает динамическое изменение правил без сброса соединений.
    - Работает с «зонами» и «сервисами».

---

---

## **Слайд 3 — iptables**

### 1. Что это такое

- **iptables** — стандартный консольный инструмент для настройки правил сетевой фильтрации в Linux.
- Работает через подсистему ядра **Netfilter**.
- Позволяет описывать, какой трафик разрешить, а какой заблокировать.

---

### 2. Принцип работы

- **Правила** группируются в **цепочки** (chains).
- Цепочки объединяются в **таблицы** (tables).
- Каждый пакет проходит через одну или несколько цепочек, пока не встретит подходящее правило.

---

### 3. Цепочки (chains)

- **INPUT** — входящие пакеты для локальной системы.
- **OUTPUT** — исходящие пакеты от локальной системы.
- **FORWARD** — транзитные пакеты, проходящие через сервер (например, если он маршрутизатор).
- **PREROUTING** — обработка пакета перед определением маршрута.
- **POSTROUTING** — обработка пакета после определения маршрута.

---

### 4. Основные таблицы (tables)

- **filter** *(по умолчанию)* — фильтрация пакетов (разрешить/запретить).
- **nat** — трансляция адресов (NAT, DNAT, SNAT).
- **mangle** — изменение заголовков пакетов (QoS, TTL).
- **raw** — отключение трекинга соединений для пакетов.
- **security** — интеграция с SELinux.

---

### 5. Пример настройки

Разрешить SSH на порт 22 и запретить всё остальное:

```bash
iptables -A INPUT -p tcp --dport 22 -j ACCEPT
iptables -A INPUT -j DROP

```

- `A INPUT` — добавить правило в цепочку входящих пакетов.
- `p tcp` — протокол TCP.
- `-dport 22` — порт назначения 22.
- `j ACCEPT` — действие: разрешить.
- `j DROP` — действие: отбросить пакет.

---

### 6. Проверка и сохранение правил

- Просмотр текущих правил:
    
    ```bash
    iptables -L -n -v
    
    ```
    
- Сохранение конфигурации:
    
    ```bash
    iptables-save > /etc/iptables/rules.v4
    
    ```
    

---

---

## **Слайд 4 — firewalld**

### 1. Что это такое

- **firewalld** — это сервис управления файрволом в Linux.
- Предоставляет **динамическую конфигурацию**: можно добавлять и изменять правила **без разрыва активных соединений**.
- Работает **поверх**:
    - **iptables** (старый backend)
    - **nftables** (новый backend, используется по умолчанию в современных системах)

---

### 2. Основные понятия

### **Zones (зоны безопасности)**

- Логические группы правил, применяемых к сетевым интерфейсам.
- Примеры зон:
    - **public** — для публичных сетей (минимум доверия).
    - **home** — для домашней сети.
    - **internal** — для внутренней корпоративной сети.
- Зоны позволяют быстро переключать политику безопасности без переписывания всех правил.

### **Services (сервисы)**

- Предустановленные наборы правил для популярных сервисов.
- Примеры:
    - `ssh` (порт 22)
    - `http` (порт 80)
    - `https` (порт 443)
- Это упрощает настройку: вместо ручного указания портов и протоколов можно просто активировать сервис.

---

### 3. Пример команд

Разрешить порт 8080 в зоне **public** и сохранить правило навсегда:

```bash
firewall-cmd --zone=public --add-port=8080/tcp --permanent
firewall-cmd --reload

```

- `-zone=public` — выбрать зону.
- `-add-port=8080/tcp` — добавить правило для TCP порта 8080.
- `-permanent` — сделать правило постоянным (иначе пропадёт после перезагрузки).
- `-reload` — применить изменения.

---

### 4. Преимущества firewalld

- **Динамическое управление** — изменения применяются без сброса соединений.
- **Гибкость** — можно быстро менять зоны и политики.
- **Удобство** — простые команды и возможность интеграции в скрипты и Ansible.
- **Совместимость** — поддерживает как iptables, так и nftables.

---

### 5. Проверка текущей конфигурации

```bash
firewall-cmd --list-all
firewall-cmd --get-active-zones
firewall-cmd --list-services

```

---

---

## **Слайд 5 — nftables**

### 1. Что это такое

- **nftables** — современная система фильтрации и обработки сетевых пакетов в Linux.
- Заменяет:
    - **iptables** (IPv4)
    - **ip6tables** (IPv6)
    - **arptables** (ARP)
    - **ebtables** (Ethernet)
- Встроен в ядро Linux **с версии 3.13**.

---

### 2. Особенности

- **Один инструмент** вместо четырёх разных утилит.
- **Универсальный синтаксис** — единый подход для IPv4, IPv6, ARP и Ethernet.
- **Одна таблица** может содержать все правила для фильтрации, NAT и модификации пакетов.
- Поддержка **сетей любого протокола** через семейства:
    - `ip` (IPv4)
    - `ip6` (IPv6)
    - `inet` (IPv4+IPv6)
    - `arp`, `bridge` и др.

---

### 3. Пример настройки

Разрешить входящие соединения по SSH и блокировать остальное:

```bash
nft add table inet filter
nft add chain inet filter input { type filter hook input priority 0; }
nft add rule inet filter input tcp dport 22 accept
nft add rule inet filter input drop

```

- `table inet filter` — создаём таблицу для IPv4 и IPv6.
- `chain input` — создаём цепочку для входящих пакетов.
- `tcp dport 22 accept` — разрешаем TCP на порт 22.
- `drop` — блокируем всё остальное.

---

### 4. Преимущества по сравнению с iptables

- **Производительность** — меньше дубликатов правил, оптимизация обработки пакетов.
- **Упрощённая конфигурация** — единая логика для всех протоколов.
- **Гибкость** — можно использовать переменные, наборы (`sets`) и карты (`maps`) для группировки правил.
- **Совместимость** — есть утилита `iptables-nft` для старых скриптов.

---

### 5. Проверка правил

```bash
nft list ruleset

```

- Показывает все таблицы, цепочки и правила.

---

---

## **Слайд 8 — Вопросы для закрепления**

### 1. Чем отличается **iptables** от **nftables**?

- **iptables**:
    - Несколько утилит для разных протоколов (iptables, ip6tables, arptables, ebtables).
    - Разные таблицы (`filter`, `nat`, `mangle`) и отдельный синтаксис.
    - Менее гибкий, устаревает.
- **nftables**:
    - Единый инструмент для IPv4, IPv6, ARP, Ethernet.
    - Универсальный синтаксис и одна таблица для всех типов фильтрации.
    - Более высокая производительность и гибкость.

---

### 2. Как работает **firewalld**?

- Управляет **Netfilter** через iptables или nftables.
- Использует **зоны** (разные политики безопасности) и **сервисы** (готовые наборы правил).
- Применяет изменения **динамически**, без разрыва активных соединений.
- Позволяет быстро переключать политики между интерфейсами и окружениями.

---

### 3. В каких случаях DevOps выбирает **stateless-файрвол**?

- **Stateless** — не отслеживает состояние соединений, каждое правило проверяется для каждого пакета отдельно.
- Используется, когда:
    - Нужна максимальная производительность (меньше нагрузки на CPU).
    - В трафике нет сложных протоколов, где важен контекст соединения.
    - Сервер работает как простая точка фильтрации (например, маршрутизатор на границе сети).
- Пример: фильтрация UDP-пакетов для блокировки DDoS.

---

### 4. Как проверить текущие правила?

- **iptables**:
    
    ```bash
    iptables -L -n -v
    
    ```
    
- **firewalld**:
    
    ```bash
    firewall-cmd --list-all
    firewall-cmd --get-active-zones
    
    ```
    
- **nftables**:
    
    ```bash
    nft list ruleset
    
    ```
    

---

---

## **Пошаговая практика**

### **Часть 1 — Подготовка**

1. Узнать, какой файрвол установлен в системе:
    
    ```bash
    which iptables
    which nft
    which firewall-cmd
    
    ```
    
2. Проверить, активен ли `firewalld`:
    
    ```bash
    systemctl status firewalld
    
    ```
    

---

### **Часть 2 — iptables**

1. Посмотреть текущие правила:
    
    ```bash
    sudo iptables -L -n -v
    
    ```
    
2. Разрешить входящие соединения на порт 8080:
    
    ```bash
    sudo iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
    
    ```
    
3. Удалить правило (по номеру):
    
    ```bash
    sudo iptables -L --line-numbers
    sudo iptables -D INPUT <номер>
    
    ```
    

---

### **Часть 3 — firewalld**

1. Проверить активные зоны:
    
    ```bash
    sudo firewall-cmd --get-active-zones
    
    ```
    
2. Разрешить HTTP (порт 80) в публичной зоне:
    
    ```bash
    sudo firewall-cmd --zone=public --add-service=http --permanent
    sudo firewall-cmd --reload
    
    ```
    
3. Проверить, что правило применилось:
    
    ```bash
    sudo firewall-cmd --list-all
    
    ```
    

---

### **Часть 4 — nftables**

1. Посмотреть все правила:
    
    ```bash
    sudo nft list ruleset
    
    ```
    
2. Создать простое правило для разрешения SSH:
    
    ```bash
    sudo nft add table inet filter
    sudo nft add chain inet filter input { type filter hook input priority 0; }
    sudo nft add rule inet filter input tcp dport 22 accept
    
    ```
    
3. Удалить таблицу:
    
    ```bash
    sudo nft delete table inet filter
    
    ```
    

---

### **Часть 5 — Проверка знаний**

- Спросить студентов:
    1. Как посмотреть текущие правила в каждом инструменте?
    2. Чем iptables отличается от nftables?
    3. Как в firewalld разрешить определённый порт?

---

Если хочешь, я могу сделать **версию этой практики для виртуальной машины с безопасным тестовым окружением**, чтобы студенты могли ломать и чинить без риска.

Сделать такой вариант?